

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    
    <meta name="author" content="xuyifei">
    
    <meta name="description" content="原文地址:http://tutorials.jenkov.com/java-servlets/gzip-servlet-filter.html
简介
A GZip Servlet Filter can be used to GZip compress content sent to a browse">
    
    

    
    <link rel="alternative" href="YOUR_RSS_ADDRESS" title="曲径通幽" type="application/atom+xml">
    
    
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>[翻译]Servlet Gzip Filter简介 | 曲径通幽</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="/css/style.css" type="text/css">

    <!-- Javascript -->
    <script src="/js/jquery-2.1.0.min.js"></script>
    <script src="/js/jquery.backstretch.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
    <script src="/js/headroom.min.js"></script>
    <script src="/js/jquery.headroom.min.js"></script> 
    <script src="/js/common.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="banner">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://evenx86.github.io" title="曲径通幽">曲径通幽</a>
            </div>

            <div role="navigation" class="collapse navbar-collapse bs-navbar-collapse">
                

                <ul class="nav navbar-nav">
                    
                    <li id="nav-index"><a href="/">首页</a></li>
                    
                    <li id="nav-archives"><a href="/archives">归档</a></li>
                    
                    <li id="nav-tags"><a href="/tags">标签</a></li>
                    
                    <li id="nav-categories"><a href="/categories">分类</a></li>
                    
                    <li id="nav-curriculumvitae"><a href="/curriculumvitae">关于</a></li>
                    
                    
                    <li><a href="https://github.com/evenX86" target="_blank">GitHub</a></li>
                </ul>
            </div>
        </div>
    </nav>
    
    <script>
    var backRoot = "/images/background/";
    var backArray = [ "1.jpg", "2.jpg", "3.jpg", "4.jpg", "5.jpg",  ];
    //console.log(backArray);
        
    $(function() {
        // page-id...
        var pageId = "2015/06/26/Servlet-gzip-filter/";
        pageId = pageId.substr(0, pageId.indexOf("/"));
        if(pageId === "") pageId = "index";
        
        $("#nav-" + pageId).addClass("active");
    });
    </script>
    <article class="post container">
    <div class="well post-body first-post last-post">
        <h1>[翻译]Servlet Gzip Filter简介</h1>
        
        <div class="time-info">
发表于:<time datetime="2015-06-26T12:16:25.091Z" itemprop="datePublished">2015-06-26</time>，更新于:<time datetime="2015-06-26T12:16:25.091Z" itemprop="dateModified">2015-06-26</time>，By <a href="http://evenx86.github.io" title="xuyifei">xuyifei</a>
        </div>
        
        <div class="post-body-inner">
            <div id="toc" class="toc-article well">
                <strong class="toc-title">大纲</strong>
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么要使用gzip压缩网页内容"><span class="toc-number">2.</span> <span class="toc-text">为什么要使用gzip压缩网页内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gzip_HTTP_Header"><span class="toc-number">3.</span> <span class="toc-text">Gzip HTTP Header</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么是Gzip_Servlet_Filter"><span class="toc-number">4.</span> <span class="toc-text">为什么是Gzip Servlet Filter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#设计Gzip_Servlet_Filter"><span class="toc-number">5.</span> <span class="toc-text">设计Gzip Servlet Filter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GZip_Servlet_Filter_编码"><span class="toc-number">6.</span> <span class="toc-text">GZip Servlet Filter 编码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#web-xml中GZip_Servlet_Filter的配置"><span class="toc-number">7.</span> <span class="toc-text">web.xml中GZip Servlet Filter的配置</span></a></li></ol>
            </div>
            
            <p>原文地址:<a href="http://tutorials.jenkov.com/java-servlets/gzip-servlet-filter.html" target="_blank" rel="external">http://tutorials.jenkov.com/java-servlets/gzip-servlet-filter.html</a></p>
<h2 id="简介">简介</h2><blockquote>
<p>A GZip Servlet Filter can be used to GZip compress content sent to a browser from a Java web application. This text will explain how that works, and contains a GZip Servlet Filter you can use in your own Java web applications. If you do not know what a Servlet filter is, read my text on Servlet Filters.</p>
</blockquote>
<p>gzip servlet filter 可用来压缩网页内容。本文将介绍其如何工作，以及如何使用gzip servlet filter 在你的web服务器中。如果不了解servlet filter是什么可以参考这篇文章:<a href="http://tutorials.jenkov.com/java-servlets/servlet-filters.html" target="_blank" rel="external">Servlet Filters.</a></p>
<h2 id="为什么要使用gzip压缩网页内容">为什么要使用gzip压缩网页内容</h2><blockquote>
<p>GZip compressing HTML, JavaScript, CSS etc. makes the data sent to the browser smaller. This speeds up the download. This is especially beneficial for mobile phones where internet bandwidth may be limited. GZip compressing content adds a CPU overhead on the server and browser, but it is still speeding up the total page load compared to not GZip compressing.</p>
</blockquote>
<p>gzip 压缩html、Javascript，css等等文件，目的是为了是发送到浏览器的数据更小，加速下载，这对于限制了带宽的移动端作用特别大。当然gzip增加了server端和浏览器端的cpu的压力，但是总体来说还是加速了页面的载入。</p>
<h2 id="Gzip_HTTP_Header">Gzip HTTP Header</h2><blockquote>
<p>The browser includes the Accept-Encoding HTTP header in requests sent to an HTTP server (e.g. a Java web server). The content of the Accept-Encoding header tells what content encodings the browser can accept. If that header contains the value gzip in it, the browser can accept GZip compressed content. The server can then GZip compress the content sent back to the browser.<br>If the content sent back from the server is GZip compressed, the server includes the Content-EncodingHTTP header with the value gzip in the HTTP response. That way the browser knows that the content is GZip compressed.</p>
</blockquote>
<p>浏览器端的HTTP报头包含<code>Accept-Encoding</code>在请求发送到一个HTTP服务器(例如Java Web Server)，包含<code>Accept-Encoding</code>请求头的主体告知服务器端该浏览器可以接收编码主体，如果头部中包含gzip，那么浏览器可以接收通过gzip压缩的主体。服务端可以发送gzip压缩主体到浏览器端。</p>
<h2 id="为什么是Gzip_Servlet_Filter">为什么是Gzip Servlet Filter</h2><blockquote>
<p>You could implement GZip compression in each and every Servlet or JSP in your application if you wanted to. But that gets clumsy.<br>The smart thing about a GZip Servlet filter is that it is executed before and after any Servlet, JSP, or even static files. That way you can create a single servlet filter that enables GZip compression for all content that needs it. The Servlets, JSPs etc. don’t even know that the content is being compressed, because it happens in the Servlet filter. The GZip Servlet filter enables GZip compression, sets the right HTTP headers, and makes sure that content written by Servlets, JSPs etc. is compressed.</p>
</blockquote>
<p>你可以在在您的应用程序中每个Servlet或JSP实现GZip压缩,但这非常麻烦。一种巧妙的GZip Servlet过滤器是它之前和之后执行任何Servlet,JSP、甚至是静态文件。通过这种方式可以创建一个servlet过滤器,使用GZip压缩所有需要的内容。Servlet、jsp等或者不需要知道什么内容的文件被压缩,因为它存在Servlet过滤器中。GZip Servlet Filter支持GZip压缩,设置正确的HTTP标头,并确保内容由Servlet、jsp等被压缩。</p>
<h2 id="设计Gzip_Servlet_Filter">设计Gzip Servlet Filter</h2><blockquote>
<p>The design of a GZip servlet filter looks like this:<img src="http://tutorials.jenkov.com/images/java-servlets/gzip-servlet-filter-1.png" alt="gzip-servlet-filter-1.png"><br>First you need a Servlet filter class. That class is mapped to a set of URL’s in the web.xml file.<br>When an HTTP request arrives at the Servlet container which is mapped to the filter, the filter intercepts the request before it is handled by the Servlet, JSP etc. which the request is targeted at. The GZip servlet filter checks if the client (browser) can accept GZip compressed content. If yes, it enables compression of the response.<br>GZip compression of the response is enabled by wrapping the HttpServletResponse object in a GZipServletResponseWrapper. This wrapper is passed to the Servlet, JSP etc. which handles the request. When the Servlet, JSP etc. writes output to be sent to the browser, it does so to the response wrapper object. The Servlet, JSP etc. cannot see the difference between a real HttpServletResponse and the wrapper object. The response wrapper object then compresses the written content and writes the compressed content to the HttpServletResponse. Quite simple.</p>
</blockquote>
<p> GZip servlet filter 的设计如上图所示，首先需要编写一个Servlet filter的类，在web.xml中设置映射到该类的URL.<br>当一个HTTP请求到达Servlet容器时候会被映射到这个filter上，filter会拦截之前处理的Servlet或者JSP等等，Gzip Servlet Filter会判断请求客户端是否接收Gzip压缩的内容，如果接收的话则允许压缩response。<br>GZip压缩的response是通过GZipServletResponseWrapper 封装 HttpServletResponse对象处理的，wrapper 处理Request传过来的Servlet、JSP等。当Servlet、JSP等写到输出并被发送到浏览器,它响应wrapper对象。Servlet和JSP等无法看到真实HttpServletResponse的区别和包装器对象,相应的wrapper对象然后压缩的内容并且写到HttpServletResponse中。</p>
<h2 id="GZip_Servlet_Filter_编码">GZip Servlet Filter 编码</h2><p>接下来的代码是Gzip Servlet Filter的代码，事实上并没有很多方式让你去写，直截了当。<br>代码包含三个类，其中<code>GZipServletFilter</code>拦截请求，检查客户端是否接收压缩，它在传递过滤链之前封装<code>HttpServletResponse</code>.<br><code>GZipServletResponseWrapper</code>response的gzip封装.<br><code>GZipServletOutputStream</code> 输出流.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GZipServletFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, </span><br><span class="line">                       ServletResponse response,</span><br><span class="line">                       FilterChain chain)</span> </span><br><span class="line">  <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    HttpServletRequest  httpRequest  = (HttpServletRequest)  request;</span><br><span class="line">    HttpServletResponse httpResponse = (HttpServletResponse) response;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( acceptsGZipEncoding(httpRequest) ) &#123;</span><br><span class="line">      httpResponse.addHeader(<span class="string">"Content-Encoding"</span>, <span class="string">"gzip"</span>);</span><br><span class="line">      GZipServletResponseWrapper gzipResponse =</span><br><span class="line">        <span class="keyword">new</span> GZipServletResponseWrapper(httpResponse);</span><br><span class="line">      chain.doFilter(request, gzipResponse);</span><br><span class="line">      gzipResponse.close();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">acceptsGZipEncoding</span><span class="params">(HttpServletRequest httpRequest)</span> </span>&#123;</span><br><span class="line">      String acceptEncoding = </span><br><span class="line">        httpRequest.getHeader(<span class="string">"Accept-Encoding"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> acceptEncoding != <span class="keyword">null</span> &amp;&amp; </span><br><span class="line">             acceptEncoding.indexOf(<span class="string">"gzip"</span>) != -<span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GZipServletResponseWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletResponseWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> GZipServletOutputStream gzipOutputStream = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">private</span> PrintWriter             printWriter      = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">GZipServletResponseWrapper</span><span class="params">(HttpServletResponse response)</span></span><br><span class="line">          <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(response);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//PrintWriter.close does not throw exceptions.</span></span><br><span class="line">      <span class="comment">//Hence no try-catch block.</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.printWriter != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">this</span>.printWriter.close();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.gzipOutputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">this</span>.gzipOutputStream.close();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="javadoc">/**</span><br><span class="line">   * Flush OutputStream or PrintWriter</span><br><span class="line">   *</span><br><span class="line">   *<span class="javadoctag"> @throws</span> IOException</span><br><span class="line">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flushBuffer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//PrintWriter.flush() does not throw exception</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.printWriter != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.printWriter.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IOException exception1 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">this</span>.gzipOutputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.gzipOutputStream.flush();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">        exception1 = e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IOException exception2 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">super</span>.flushBuffer();</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IOException e)&#123;</span><br><span class="line">      exception2 = e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(exception1 != <span class="keyword">null</span>) <span class="keyword">throw</span> exception1;</span><br><span class="line">    <span class="keyword">if</span>(exception2 != <span class="keyword">null</span>) <span class="keyword">throw</span> exception2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ServletOutputStream <span class="title">getOutputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.printWriter != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">        <span class="string">"PrintWriter obtained already - cannot get OutputStream"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.gzipOutputStream == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.gzipOutputStream = <span class="keyword">new</span> GZipServletOutputStream(</span><br><span class="line">        getResponse().getOutputStream());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.gzipOutputStream;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> PrintWriter <span class="title">getWriter</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.printWriter == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.gzipOutputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">         <span class="string">"OutputStream obtained already - cannot get PrintWriter"</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.printWriter == <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">this</span>.gzipOutputStream = <span class="keyword">new</span> GZipServletOutputStream(</span><br><span class="line">         getResponse().getOutputStream());</span><br><span class="line">       <span class="keyword">this</span>.printWriter      = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> OutputStreamWriter(</span><br><span class="line">       <span class="keyword">this</span>.gzipOutputStream, getResponse().getCharacterEncoding()));</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">this</span>.printWriter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentLength</span><span class="params">(<span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//ignore, since content length of zipped content</span></span><br><span class="line">    <span class="comment">//does not match content length of unzipped content.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GZipServletOutputStream</span> <span class="keyword">extends</span> <span class="title">ServletOutputStream</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> GZIPOutputStream    gzipOutputStream = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">GZipServletOutputStream</span><span class="params">(OutputStream output)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.gzipOutputStream = <span class="keyword">new</span> GZIPOutputStream(output);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.gzipOutputStream.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.gzipOutputStream.flush();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">byte</span> b[])</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.gzipOutputStream.write(b);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">byte</span> b[], <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.gzipOutputStream.write(b, off, len);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> b)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">     <span class="keyword">this</span>.gzipOutputStream.write(b);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="web-xml中GZip_Servlet_Filter的配置">web.xml中GZip Servlet Filter的配置</h2><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">&lt;filter&gt;</span></span><br><span class="line">  <span class="variable">&lt;filter-name&gt;</span>GzipFilter<span class="variable">&lt;/filter-name&gt;</span></span><br><span class="line">  <span class="variable">&lt;filter-class&gt;</span>com.myapp.GZipServletFilter<span class="variable">&lt;/filter-class&gt;</span></span><br><span class="line"><span class="variable">&lt;/filter&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">&lt;filter-mapping&gt;</span></span><br><span class="line">  <span class="variable">&lt;filter-name&gt;</span>GzipFilter<span class="variable">&lt;/filter-name&gt;</span></span><br><span class="line">  <span class="variable">&lt;url-pattern&gt;</span><span class="keyword">*</span>.js<span class="variable">&lt;/url-pattern&gt;</span></span><br><span class="line"><span class="variable">&lt;/filter-mapping&gt;</span></span><br><span class="line"><span class="variable">&lt;filter-mapping&gt;</span></span><br><span class="line">  <span class="variable">&lt;filter-name&gt;</span>GzipFilter<span class="variable">&lt;/filter-name&gt;</span></span><br><span class="line">  <span class="variable">&lt;url-pattern&gt;</span><span class="keyword">*</span>.css<span class="variable">&lt;/url-pattern&gt;</span></span><br><span class="line"><span class="variable">&lt;/filter-mapping&gt;</span></span><br><span class="line"><span class="variable">&lt;filter-mapping&gt;</span></span><br><span class="line">  <span class="variable">&lt;filter-name&gt;</span>GzipFilter<span class="variable">&lt;/filter-name&gt;</span></span><br><span class="line">  <span class="variable">&lt;url-pattern&gt;</span><span class="keyword">*</span>.html<span class="variable">&lt;/url-pattern&gt;</span></span><br><span class="line"><span class="variable">&lt;/filter-mapping&gt;</span></span><br><span class="line"><span class="variable">&lt;filter-mapping&gt;</span></span><br><span class="line">  <span class="variable">&lt;filter-name&gt;</span>GzipFilter<span class="variable">&lt;/filter-name&gt;</span></span><br><span class="line">  <span class="variable">&lt;url-pattern&gt;</span><span class="keyword">*</span>.jsp<span class="variable">&lt;/url-pattern&gt;</span></span><br><span class="line"><span class="variable">&lt;/filter-mapping&gt;</span></span><br><span class="line"><span class="variable">&lt;filter-mapping&gt;</span></span><br><span class="line">  <span class="variable">&lt;filter-name&gt;</span>GzipFilter<span class="variable">&lt;/filter-name&gt;</span></span><br><span class="line">  <span class="variable">&lt;url-pattern&gt;</span>/<span class="variable">&lt;/url-pattern&gt;</span></span><br><span class="line"><span class="variable">&lt;/filter-mapping&gt;</span></span><br></pre></td></tr></table></figure>
            
            <section class="comment">
	<div class="ds-thread"></div>
</section>

<script type="text/javascript">
  var duoshuoQuery = {short_name:"evenx86"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 
        </div>
    </div>
</article>

    <footer id="footer">
    <div id="bottom-tip">
        曲径通幽
    </div>
        <small>该博客由 <a href="https://hexo.io/" target="_blank">Hexo</a> 强力驱动，主题<a href="https://github.com/XadillaX/hexadillax" target="_blank">Hexadillax</a></small><br />
        <small>&copy; 2015 xuyifei </small>
    </footer>
</body>
</html>
